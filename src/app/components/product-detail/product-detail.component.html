<div class="product-detail-container" *ngIf="!isLoading && articulo">
  <div class="back-button">
    <button mat-button (click)="volverALista()">
      <mat-icon>arrow_back</mat-icon>
      Volver a la tienda
    </button>
  </div>

  <div class="product-content">
    <!-- Imagen principal -->
    <div class="product-image-section">
      <div class="image-container">
        <img [src]="articulo.imagen || '/assets/images/no-image.svg'"
             [alt]="articulo.nombre"
             (error)="onImageError($event)"
             class="main-image">
        <div class="image-overlay" *ngIf="!articulo.activo">
          <span class="out-of-stock-badge">Producto no disponible</span>
        </div>
      </div>
    </div>

    <!-- Información del producto -->
    <div class="product-info-section">
      <div class="product-header-section">
        <h1 class="product-title">{{ articulo.nombre }}</h1>
        <div class="product-meta">
          <span class="product-code">Código: {{ articulo.codigoArticulo }}</span>
          <div class="product-badges">
            <mat-chip-listbox>
              <mat-chip (click)="goToCategoria(articulo.categoriaId)">
                {{ articulo.categoriaNombre }}
              </mat-chip>
              <mat-chip *ngIf="articulo.subcategoriaNombre" (click)="goToSubcategoria(articulo.subcategoriaId)">
                {{ articulo.subcategoriaNombre }}
              </mat-chip>
            </mat-chip-listbox>
          </div>
        </div>
      </div>

      <mat-divider class="section-divider"></mat-divider>

      <div class="product-details-section">
        <!-- Precio -->
        <div class="price-display-section">
          <div class="price-main">
            <span class="price-label">Precio</span>
            <span class="price-value" [ngClass]="getPriceClass()">
              ${{ getDisplayPrice() | number:'1.2-2' }}
            </span>
            <span class="price-per-unit">/unidad</span>
          </div>
          <div class="price-note" *ngIf="isWorkshopUser() && articulo.precioTaller !== articulo.precioUsuario">
            <mat-icon>info</mat-icon>
            Precio especial para talleres
          </div>
        </div>

        <!-- Stock -->
        <div class="stock-display" [ngClass]="getStockClass()">
          <mat-icon>{{ getStockIcon() }}</mat-icon>
          <div class="stock-info">
            <span class="stock-status">{{ getStockStatus() }}</span>
            <span class="stock-quantity" *ngIf="articulo.stock > 0">
              ({{ articulo.stock }} disponibles)
            </span>
          </div>
        </div>

        <!-- Selector de cantidad (solo si hay stock) -->
        <div class="quantity-section" *ngIf="articulo.stock > 0">
          <app-quantity-selector
            [maxQuantity]="articulo.stock"
            [initialQuantity]="selectedQuantity"
            (quantityChange)="onQuantityChange($event)">
          </app-quantity-selector>
        </div>
      </div>

      <mat-divider class="section-divider"></mat-divider>

      <!-- Descripción -->
      <div class="description-section" *ngIf="articulo.descripcion">
        <h3 class="section-title">Descripción del producto</h3>
        <p class="product-description">{{ articulo.descripcion }}</p>
      </div>

      <!-- Características técnicas -->
      <div class="specs-section">
        <h3 class="section-title">Características técnicas</h3>
        <div class="specs-grid">
          <div class="spec-item">
            <span class="spec-label">Código de artículo:</span>
            <span class="spec-value">{{ articulo.codigoArticulo }}</span>
          </div>
          <div class="spec-item">
            <span class="spec-label">Categoría:</span>
            <span class="spec-value">{{ articulo.categoriaNombre }}</span>
          </div>
          <div class="spec-item" *ngIf="articulo.subcategoriaNombre">
            <span class="spec-label">Subcategoría:</span>
            <span class="spec-value">{{ articulo.subcategoriaNombre }}</span>
          </div>
          <div class="spec-item">
            <span class="spec-label">Stock disponible:</span>
            <span class="spec-value">{{ articulo.stock }}</span>
          </div>
          <div class="spec-item" *ngIf="articulo.tallerIds.length > 0">
            <span class="spec-label">Talleres asociados:</span>
            <span class="spec-value">{{ articulo.tallerIds.length }} taller(es)</span>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="action-buttons-section">
        <button mat-raised-button
                color="primary"
                class="action-button primary-action"
                (click)="agregarAlCarrito()"
                [disabled]="!canAddToCart()">
          <mat-icon>add_shopping_cart</mat-icon>
          Agregar al carrito
        </button>

        <button mat-raised-button
                color="accent"
                class="action-button secondary-action"
                (click)="comprarAhora()"
                [disabled]="!canAddToCart()">
          <mat-icon>shopping_bag</mat-icon>
          Comprar ahora
        </button>
      </div>
    </div>
  </div>

  <!-- Productos relacionados -->
  <div class="related-products" *ngIf="articulosRelacionados.length > 0">
    <h2>Productos relacionados</h2>
    <div class="related-grid">
      <mat-card *ngFor="let related of articulosRelacionados"
                class="related-card"
                (click)="verArticuloRelacionado(related)">
        <img mat-card-image [src]="related.imagen || '/assets/images/no-image.png'" [alt]="related.nombre">

        <mat-card-content>
          <h4 class="related-title">{{ related.nombre }}</h4>
          <p class="related-price">${{ related.precioUsuario | number:'1.2-2' }}</p>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Loading indicator -->
<div *ngIf="isLoading" class="loading">
  <mat-icon class="spinning">refresh</mat-icon>
  <span>Cargando producto...</span>
</div>

<!-- Error state -->
<div *ngIf="!isLoading && !articulo" class="error-state">
  <mat-icon>error_outline</mat-icon>
  <h3>Producto no encontrado</h3>
  <p>El producto que buscas no existe o no está disponible.</p>
  <button mat-button (click)="volverALista()">
    <mat-icon>arrow_back</mat-icon>
    Volver a la tienda
  </button>
</div>
